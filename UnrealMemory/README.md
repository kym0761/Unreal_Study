# Unreal_Study/Unreal Memory

## 설명

언리얼은 C++의 단점을 해결하기 위해서 가비지 컬렉션을 도입했다는 내용을 설명하는 텍스트임.

## 잘못된 포인터 사용 예시

메모리 누수 : new , delete가 짝이 안맞아서 힙에 메모리가 남음
dangling 포인터 : 해제된 위치를 가리키는 포인터
wild 포인터 : 값이 초기화되지 않아서 엉뚱한 곳을 가리키는 포인터

## 가비지 컬렉션

오브젝트를 사용하지 않는다면 자동으로 감지해 메모리를 회수하는 시스템

동적으로 생성된 오브젝트 정보를 모아놓은 저장소를 통해 사용하지 않는 메모리를 추적함

### mark-sweep 방식

1. 저장소 최초 검색을 시작하는 루트 오브젝트를 먼저 표기함
2. 루트 오브젝트를 참조하는 객체를 mark 함
3. mark된 객체로부터 다시 참조하는 객체를 찾아 또 mark 하고 이를 반복함
4. 저장소에 mark된 객체와 마크되지 않는 객체 두 그룹으로 나눔
5. mark 되지 않은 객체를 가비지 컬렉터가 메모리를 sweep함.

## 언리얼의 가비지 컬렉션

위에 언급된 mark sweep 방식임

지정된 주기마다 몰아서 없애도록 설정되어 있음.

project settings -> garbage collection에 있음 (기본 GCCycle 60초)

성능 향상을 위해 병렬 처리 , 클러스터링 기능이 탑재됨.

언리얼엔진에서 관리되는 모든 언리얼 오브젝트는 GUObjectArray라는 전역 공간에 저장함

각 오브젝트마다 Flag가 설정되어 있음

주요 플래그는 2가지다

### Flag

1. Garbage Flag : 다른 언리얼 오브젝트로부터 참조가 되지 않아 회수될 예정인 오브젝트
2. RootSet Flag : 다른 언리얼 오브젝트로부터 참조가 없어도 회수되지 않을 특별한 오브젝트

요약 : 가비지 컬렉터에서 GUObjectArray의 플래그를 확인해 빠르게 회수해야할 오브젝트를 파악하여 메모리에서 제거함

## Garbage Flag

가비지 컬렉터는 지정된 시간마다 주기적으로 메모리를 회수함

Garbage 플래그로 설정된 오브젝트를 파악해 메모리를 안전하게 회수함

이 플래그는 수동으로 설정하는 것이 아니라 시스템에서 알아서 설정하기 때문에 사용자는 몰라도 됨.

참고로, 언리얼 오브젝트는 한번 생성하면 사용자가 강제로 바로 삭제하는 것이 불가능한 것이다.

강제로 지우는 것 보다, 참조를 끊는 정도로 설계하면 된다.

Destroy()도 사실 내부 동작이 가비지 컬렉션에 의존된 방식이다.

## RootSet Flag

AddToRoot()를 사용해 루트셋 플래그를 설정하면 최초 탐색 목록으로 설정된다.

루트셋으로 설정된 언리얼 오브젝트는 메모리 회수로부터 보호받는다.

RemoveFromRoot()를 사용하면 루트셋 flag를 제거할 수 있음.

위의 방법은 사용을 추천하지 않음. -- 말하자면 Outer는 그냥 사용자가 구현한 콘텐츠끼리 하는 것이 좋음.


## 이 방식으로 해결되는 문제

### 메모리 누수

언리얼 가비지 컬렉터가 해결해줌

퓨어 C++ 오브젝트는 신경써야함 - 스마트 포인터로 해결

### 댕글링 포인터

IsValid()가 해결해줌

퓨어 C++ 오브젝트는 신경을 써야함

### 와일드 포인터

UPROPERTY()를 언리얼 오브젝트에 지정하면 nullptr로 자동을 초기화해줌

퓨어 C++ 오브젝트 포인터는 직접 nullptr로 초기화해야함 - 이 또한 스마트 포인터가 해결해줌.
 
### 안전한 언리얼 오브젝트

!언리얼 엔진 방식으로 참조를 설정한 언리얼 오브젝트들
1. UPROPERTY()로 설정된 언리얼 오브젝트의 참조 포인터 (대부분)
2. 위 방식이 불가능하다면, AddReferencedObjects()를 통해 참조를 설정한 언리얼 오브젝트 (권장안함)

!RootSet으로 지정된 언리얼 오브젝트들



### 일반 클래스에서 언리얼 오브젝트를 관리해야할 때

UPROPERTY()를 사용하지 못하는 퓨어 C++ 클래스들이 이에 해당함 (위에 언급된 2번째)

순수 C++ 클래스는 UCLASS()가 아니므로 멤버변수에 UPROPERTY()를 지정해도 가비지 컬렉션을 막을 수 없음.

FGCObject를 상속받은 후에, 
1. void AddReferencedObjects()를 구현한다.
2. FString GetReferencerName() const 를 구현한다.

함수 구현부에는 관리할 언리얼 오브젝트를 추가해준다.

이 내용은 UnrealC++_Template를 참고하면 좋다.